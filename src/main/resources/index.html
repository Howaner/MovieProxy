<html>
	<head>
		<link rel="stylesheet" href="assets/css/bootstrap.min.css" />
		<script src="assets/js/jquery-3.3.1.min.js"></script>
		<script src="assets/js/gijgo.min.js"></script>
		<link rel="stylesheet" href="assets/css/gijgo.min.css" />

		<title>MovieProxy</title>
	</head>
	<body class="bg-light">
		<div class="container">
			<form method="get" action="/upload" class="needs-validation">
				<div class="py-5 text-center">
					<img class="d-block mx-auto mb-4" src="assets/img/logo.png" alt="" width="94" height="94" />
					<h2>Movie Proxy</h2>
					<p class="lead">Lade jetzt ein Video herunter!</p>
					<a href="movies"><button class="btn btn-secondary" type="button">Bereits heruntergeladene Videos</button></a>
				</div>

				<div class="row">
					<div class="col-md-4 order-md-2 mb-4">
						<h4 class="d-flex justify-content-between align-items-center mb-3">
							<span class="text-muted">Downloads</span>
							<span class="badge badge-secondary badge-pill" id="downloadsAmount">0</span>
						</h4>

						<ul class="list-group mb-3" id="downloads">
							<!--<li class="list-group-item">
								<h6 class="my-0">S01E01.mp4</h6>
								<small class="text-muted">/Animes/Black Clover</small>
								<div class="progress" style="height:20px">
									<div class="progress-bar" style="width:40%;height:20px"></div>
								</div>
							</li>-->
						</ul>
					</div>

					<div class="col-md-8 order-md-1">
						<h4 class="mb-3">Dateidownload</h4>
						<div class="md-3">
							<label for="filename">Dateiname</label>
							<input type="text" class="form-control" id="filename" name="filename" placeholder="" value="" required />
							<div class="invalid-feedback" style="width: 100%">Der Dateiname wird benötigt.</div>
						</div>
						<div class="md-3">
							<label for="url">Stream URL</label>
							<input type="text" class="form-control" id="url" name="url" placeholder="" value="" required />
							<div class="invalid-feedback" style="width: 100%">Die Stream URL wird benötigt.</div>
						</div>

						<hr class="mb-4" />
						<div class="container-fluid">
							<h4 class="mb-3">Speicherpfad</h4>
							<!--<input type="hidden" name="savepath" id="savepath" />-->
							<input type="text" name="savepath" id="savepath" style="display: none" /> <!-- Use type="text" instead of hidden that chrome restores the field after page switch -->
							<div id="tree"></div>
						</div>
						<hr class="mb-4" />

						<button class="btn btn-primary btn-lg btn-block" type="submit">Download!</button>
					</div>
				</div>
			</form>
		</div>

		<script type="text/javascript">
			function updateDownloads() {
				$.ajax({
					url: 'data/downloads.json',
					cache: false
				}).done(function(data) {
					var downloadsRegion = $("#downloads");
					downloadsRegion.empty();

					data.forEach(function(elem) {
						var region = $('<li class="list-group-item">');
						region.append('<h6 class="my-0"><a href="' + elem.streamingUrl + '">' + elem.saveFileName + '</a></h6>');
						region.append('<small class="text-muted">' + elem.saveFolder + '</small>');
						region.append('<div class="progress" style="height:20px"><div class="progress-bar" style="width:' + elem.progress + '%;height:20px"></div></div>');

						downloadsRegion.append(region);
					});

					$("#downloadsAmount").html(data.length);
				});
			}

			$(function() {
				console.log($('#savepath').val());
				
				// http://gijgo.com/tree/demos/bootstrap-4-treeview
				var tree = $('#tree').tree({
					uiLibrary: 'bootstrap4',
					dataSource: 'data/folders.json',
					primaryKey: 'identifier',
					selectionType: 'single'
				});
				tree.on('select', function(e, node, id) {
					$("#savepath").val(id);
				});
				tree.on('unselect', function(e, node, id) {
					$('#savepath').val('');
				});

				// Restore last path selection
				var cachedPath = $("#savepath").val();
				if (cachedPath) {
					tree.on('dataBound', function(e, node, id) {
						var node = tree.getNodeById(cachedPath);
						if (node) {
							tree.select(node);

							// Expand all parent nodes from the selected node
							var parentNode = $(node[0].parentNode).closest('li');
							while (parentNode.length !== 0) {
								var parentTreeNode = tree.getNodeById(parentNode.attr('data-id'));
								if (parentTreeNode) {
									tree.expand(parentTreeNode);
									parentNode = $(parentNode[0].parentNode).closest('li');
								} else {
									break;
								}
							}
						}
					});
				}

				updateDownloads();
				setInterval(updateDownloads, 5000);
			});
		</script>
	</body>
</html>
